name: Build OpenWrt LuCI Package

on:
  # 推送到 main 分支时触发
  push:
    branches: [ main, master ]
  # Pull Request 时触发
  pull_request:
    branches: [ main, master ]
  # 手动触发
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'OpenWrt SDK Version'
        required: true
        default: '24.10.0'
        type: choice
        options:
          - '24.10.0'
          - '23.05.5'
          - '23.05.4'
      target:
        description: 'Target Architecture'
        required: true
        default: 'x86-64'
        type: choice
        options:
          - 'x86-64'
          - 'rockchip-armv8'
          - 'mediatek-filogic'
          - 'ramips-mt7621'
          - 'all'

env:
  PACKAGE_NAME: luci-app-overlay-backup

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86_64 架构（常见软路由、iStoreOS x86）
          - target: x86-64
            sdk_url_path: targets/x86/64
            sdk_name_pattern: openwrt-sdk-*-x86-64_gcc-*
          # Rockchip ARM64（如 R2S、R4S、R5S、R68S）
          - target: rockchip-armv8
            sdk_url_path: targets/rockchip/armv8
            sdk_name_pattern: openwrt-sdk-*-rockchip-armv8_gcc-*
          # MediaTek Filogic（如 红米 AX6000、GL-MT6000）
          - target: mediatek-filogic
            sdk_url_path: targets/mediatek/filogic
            sdk_name_pattern: openwrt-sdk-*-mediatek-filogic_gcc-*
          # Ramips MT7621（如 小米路由器、新路由3）
          - target: ramips-mt7621
            sdk_url_path: targets/ramips/mt7621
            sdk_name_pattern: openwrt-sdk-*-ramips-mt7621_gcc-*

    name: Build for ${{ matrix.target }}
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools python3-dev rsync swig unzip zlib1g-dev file wget zstd

      - name: Determine SDK version
        id: sdk_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.sdk_version }}" ]; then
            echo "version=${{ inputs.sdk_version }}" >> $GITHUB_OUTPUT
          else
            echo "version=24.10.0" >> $GITHUB_OUTPUT
          fi

      - name: Download OpenWrt SDK
        run: |
          SDK_VERSION="${{ steps.sdk_version.outputs.version }}"
          SDK_BASE_URL="https://downloads.openwrt.org/releases/${SDK_VERSION}/${{ matrix.sdk_url_path }}"
          
          echo "Fetching SDK list from: ${SDK_BASE_URL}"
          
          # 获取 SDK 文件名
          SDK_FILE=$(curl -s "${SDK_BASE_URL}/" | grep -oP 'openwrt-sdk[^"]+\.tar\.(xz|zst)' | head -1)
          
          if [ -z "$SDK_FILE" ]; then
            echo "Error: Could not find SDK file"
            exit 1
          fi
          
          echo "Downloading: ${SDK_BASE_URL}/${SDK_FILE}"
          wget -q "${SDK_BASE_URL}/${SDK_FILE}" -O sdk.tar.${SDK_FILE##*.}
          
          # 解压
          if [[ "$SDK_FILE" == *.zst ]]; then
            zstd -d sdk.tar.zst
            tar -xf sdk.tar
          else
            tar -xJf sdk.tar.xz
          fi
          
          # 重命名为统一名称
          mv openwrt-sdk-* openwrt-sdk
          
          echo "SDK downloaded and extracted successfully"
          ls -la openwrt-sdk/

      - name: Prepare package source
        run: |
          # 创建 package 目录结构
          mkdir -p openwrt-sdk/package/${{ env.PACKAGE_NAME }}
          
          # 复制所有源文件（排除 .git 和 .github）
          rsync -av --exclude='.git' --exclude='.github' --exclude='openwrt-sdk' ./ openwrt-sdk/package/${{ env.PACKAGE_NAME }}/
          
          echo "Package structure:"
          ls -la openwrt-sdk/package/${{ env.PACKAGE_NAME }}/

      - name: Update and install feeds
        working-directory: openwrt-sdk
        run: |
          # 更新 feeds
          ./scripts/feeds update -a
          
          # 安装所有 feeds
          ./scripts/feeds install -a
          
          # 确保 luci 相关依赖已安装
          ./scripts/feeds install luci-base luci-compat || true

      - name: Configure build
        working-directory: openwrt-sdk
        run: |
          # 生成默认配置
          make defconfig
          
          # 启用我们的包
          echo "CONFIG_PACKAGE_${{ env.PACKAGE_NAME }}=y" >> .config
          
          # 更新配置
          make defconfig
          
          # 显示配置
          grep -E "^CONFIG_PACKAGE_luci" .config | head -20 || true

      - name: Compile package
        working-directory: openwrt-sdk
        run: |
          # 编译包（使用所有 CPU 核心）
          make package/${{ env.PACKAGE_NAME }}/compile V=s -j$(nproc) || \
          make package/${{ env.PACKAGE_NAME }}/compile V=s -j1

      - name: Collect artifacts
        id: collect
        run: |
          mkdir -p artifacts
          
          # 查找并复制 ipk 文件
          find openwrt-sdk/bin -name "*.ipk" | while read ipk; do
            echo "Found: $ipk"
            cp "$ipk" artifacts/
          done
          
          # 添加架构后缀到文件名
          cd artifacts
          for f in *.ipk; do
            if [ -f "$f" ]; then
              newname="${f%.ipk}_${{ matrix.target }}.ipk"
              mv "$f" "$newname"
              echo "Renamed to: $newname"
            fi
          done
          
          ls -la
          
          # 检查是否有文件
          if [ -z "$(ls -A .)" ]; then
            echo "No artifacts found!"
            exit 1
          fi
          
          echo "artifact_count=$(ls -1 *.ipk 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ matrix.target }}
          path: artifacts/*.ipk
          retention-days: 30

  # 合并所有架构的构建产物
  merge-artifacts:
    needs: build
    runs-on: ubuntu-22.04
    name: Merge all artifacts
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: ${{ env.PACKAGE_NAME }}-*
          merge-multiple: true

      - name: List all packages
        run: |
          echo "=========================================="
          echo "All compiled packages:"
          echo "=========================================="
          ls -la all-artifacts/
          echo "=========================================="

      - name: Upload merged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-all-architectures
          path: all-artifacts/*.ipk
          retention-days: 90

  # 创建 Release（仅在打 tag 时）
  release:
    needs: merge-artifacts
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/v')
    name: Create Release
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-all-architectures
          path: release-files

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*.ipk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
